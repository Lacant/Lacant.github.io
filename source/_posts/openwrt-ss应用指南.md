---
title: fq原理
date: 2018-3-20 23:55:29
tags: [fq,路由]
categories: 网络技术
toc: true
---

* OpenwrtSS所需组件:
 - dnsmasq
 - ChinaDns
 - Shadowsocks
* 各组件的功用:
 * dnsmasq 提供DNS解析指向服务，它可以将网内电脑提交的DNS解析请求拦截，由用户指定DNS解析服务的指向。这一功能通过设置“常规设置-DNS转发”来实现，比如：在“DNS转发”这一栏填入：127.0.0.1#5353，意味着电脑提交的DNS解析请求会全部转发到127.0.0.1这个IP地址的5353端口。另外，dnsmasq是通过53端口来监听所有IP段的。
 * ChinaDns的作用是提供DNS解析的分流服务，它通过54713及5353两个端口监听局域网内所有请求，当dnsmasq向5353端口转发请求时，它将接收到的请求通过chinaroute这个文件列表中的内容进行对比，通过对比IP来识别是否为国外IP地址，如果判定为国外IP，就会将结果发送至本机5300端口，也就是所谓的上游服务器127.0.0.1：5300的由来。如果判定为国内端口，就将其发送到国内的DNS服务器上进行解析，比如114.114.114.114等。
 * 当ChinaDns将结果转发到本机5300端口时，Shadowsocks如果启用了UDP转发功能，并且监听5300端口的话，它就会将解析请求加密传输至指定的DNS服务器进行解析，以此躲避DNS污染。
* 故障排查：
 - 首先确认Shadowsocks是否正常运行，ping服务器地址，看看是否是通的，再用putty 输入指令netstat -lnp来查看SS是否在监听端口，再查看UDP转发的服务器是否是正常工作的，如果都是正常的话，那最有可能出现问题的就是ChinaDns没有正常工作了，此时再查看是否转发到了正确的本机端口，另外再更新chinaroute list看看，基本上到这步，所有的问题都可以解决了。
